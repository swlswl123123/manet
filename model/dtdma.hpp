#pragma once
#include <antenna.hpp>
#include <list>
#include <map>
#include <deque>
#include <vector>
#include <node.hpp>
#include <transfer_queue.hpp>
#define OPNET
#include <balloc.hpp>
#include <position_manager.hpp>

#define SCAN_SECTORS 5184

#define NUM_SHORT_FRAME_PER_SECOND_DISCON 16
#define NUM_SHORT_FRAME_PER_SECOND_CONN 16
#define NUM_ND_PER_SHORT_FRAME 4
#define NUM_D_PER_SHORT_FRAME 28
#define NUM_D

#define OFFNET_FRAME_INTERVAL 36e-3
#define ASYNC_FRAME_INTERVAL 36e-3
#define INNET_FRAME_INTERVAL 36e-3
#define GAURD_INTERVAL 500e-6
#define TRANSIT_INTERVAL 50e-6
#define ND_INTERVAL 100e-6
#define N_INTERVAL 2e-3
#define D_INTERVAL 1e-3
#define DT_INTERVAL (D_INTERVAL - TRANSIT_INTERVAL - GAURD_INTERVAL)

namespace dtdma_ns
{
typedef enum strm
{
  FROM_TCB,
  TO_TCB,
  RRC_ND,
  RRC_LINK,           //Notifying link state update
  RRC_LINK_BROADCAST, // Broadcasting link infomation
  RRC_FWD_TBL,        // Forward table update interface
  TRAFFIC,            //Traffic interface
  TRAFFIC_URG,        //Urgent traffic
  RRC_BALLOC,         //Beacon allocation interface
  RRC_BALLOC_REQ,     // Beacon allocation request
  RRC_LINK_UNICAST,   //Link info unicast channel
  RRC_RELEASE
} strm_t;

typedef enum intrpt
{
  C,
  ON_NDCH_DL,
  ON_LINK_UPDATE,
  ON_FWD_TBL_UPDATE,
  ON_NETSTATE_UPDATE,
  ON_LBCH_DL,
  ON_TRAFFIC_DL,
  ON_TRAFFIC_URG_DL,
  ON_BALLOC_DL,
  ON_LUCH_DL,
  N = 0x00000100,
  ND = 0x00000200,
  D = 0x00000300,
  DT = 0x00000400,
  DR = 0x00000500,
  SF = 0x00000600

} intrpt_t;
typedef enum ptype
{
  ETHERTYPE_IP = 0x0800,
  ETHERTYPE_ARP = 0x0806,
  ETHERTYPE_IPV6 = 0x86dd,
  EHTERTYPE_BALLOC = 0x7240, //Beacon allocation message type
  EHTERTYPE_RINFO = 0x7241,   //Link info message type
  EHTERTYPE_POS = 0x7242
} ptype_t;

typedef enum prio
{
  DBCH,  //Data broadcast channel
  CBCH,  //Control broadcast channel
  U1,    //Data unicast channel
  U2,    //Data half urgent channel
  CUCH,  //Control unicast channel
  UDBCH, //Urgent data broadcast channel
  UCBCH, //Urgent control broadcast channel
  U3,    //Urgent data unicast channel
  UCUCH  //Urgent control unicast channel
} prio_t;

}; // namespace dtdma_ns
const int sec_seq[] = {
1,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,2,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,3,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,4,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,5,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,6,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,7,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,8,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,9,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,10,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,11,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,12,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,13,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,14,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,15,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,271,16,272,273,274,275,276,277,278,279,280,281,282,283,284,285,286,287,288,17,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,33,18,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,19,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,20,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,21,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,22,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,23,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,24,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,25,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,26,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,27,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,28,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,29,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,30,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,31,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,271,32,272,273,274,275,276,277,278,279,280,281,282,283,284,285,286,287,288,33,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,34,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,49,50,35,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,36,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,37,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,38,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,39,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,40,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,41,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,42,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,43,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,44,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,45,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,46,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,47,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,271,48,272,273,274,275,276,277,278,279,280,281,282,283,284,285,286,287,288,49,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,50,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,51,35,36,37,38,39,40,41,42,43,44,45,46,47,48,65,66,67,52,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,53,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,54,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,55,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,56,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,57,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,58,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,59,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,60,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,61,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,62,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,63,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,271,64,272,273,274,275,276,277,278,279,280,281,282,283,284,285,286,287,288,65,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,66,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,67,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,68,52,53,54,55,56,57,58,59,60,61,62,63,64,81,82,83,84,69,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,70,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,71,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,72,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,73,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,74,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,75,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,76,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,77,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,78,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,79,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,271,80,272,273,274,275,276,277,278,279,280,281,282,283,284,285,286,287,288,81,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,82,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,83,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,84,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,85,69,70,71,72,73,74,75,76,77,78,79,80,97,98,99,100,101,86,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,87,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,88,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,89,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,90,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,91,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,92,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,93,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,94,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,95,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,271,96,272,273,274,275,276,277,278,279,280,281,282,283,284,285,286,287,288,97,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,98,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,99,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,100,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,101,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,102,86,87,88,89,90,91,92,93,94,95,96,113,114,115,116,117,118,103,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,104,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,105,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,106,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,107,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,108,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,109,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,110,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,111,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,271,112,272,273,274,275,276,277,278,279,280,281,282,283,284,285,286,287,288,113,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,114,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,115,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,116,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,117,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,118,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,119,103,104,105,106,107,108,109,110,111,112,129,130,131,132,133,134,135,120,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,121,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,122,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,123,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,124,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,125,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,126,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,127,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,271,128,272,273,274,275,276,277,278,279,280,281,282,283,284,285,286,287,288,129,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,130,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,131,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,132,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,133,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,134,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,135,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,136,120,121,122,123,124,125,126,127,128,145,146,147,148,149,150,151,152,137,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,138,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,139,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,140,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,141,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,142,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,143,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,271,144,272,273,274,275,276,277,278,279,280,281,282,283,284,285,286,287,288,145,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,146,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,147,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,148,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,149,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,150,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,151,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,152,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,153,137,138,139,140,141,142,143,144,161,162,163,164,165,166,167,168,169,154,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,155,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,156,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,157,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,158,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,159,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,271,160,272,273,274,275,276,277,278,279,280,281,282,283,284,285,286,287,288,161,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,162,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,163,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,164,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,165,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,166,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,167,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,168,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,169,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,170,154,155,156,157,158,159,160,177,178,179,180,181,182,183,184,185,186,171,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,172,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,173,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,174,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,175,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,271,176,272,273,274,275,276,277,278,279,280,281,282,283,284,285,286,287,288,177,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,178,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,179,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,180,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,181,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,182,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,183,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,184,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,185,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,186,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,187,171,172,173,174,175,176,193,194,195,196,197,198,199,200,201,202,203,188,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,189,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,190,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,191,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,271,192,272,273,274,275,276,277,278,279,280,281,282,283,284,285,286,287,288,193,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,194,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,195,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,196,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,197,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,198,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,199,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,200,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,201,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,202,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,203,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,204,188,189,190,191,192,209,210,211,212,213,214,215,216,217,218,219,220,205,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,206,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,207,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,271,208,272,273,274,275,276,277,278,279,280,281,282,283,284,285,286,287,288,209,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,210,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,211,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,212,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,213,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,214,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,215,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,216,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,217,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,218,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,219,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,220,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,221,205,206,207,208,225,226,227,228,229,230,231,232,233,234,235,236,237,222,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,223,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,271,224,272,273,274,275,276,277,278,279,280,281,282,283,284,285,286,287,288,225,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,226,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,227,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,228,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,229,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,230,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,231,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,232,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,233,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,234,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,235,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,236,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,237,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,238,222,223,224,241,242,243,244,245,246,247,248,249,250,251,252,253,254,239,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,271,240,272,273,274,275,276,277,278,279,280,281,282,283,284,285,286,287,288,241,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,242,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,243,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,244,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,245,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,246,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,247,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,248,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,249,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,250,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,251,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,252,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,253,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,254,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,255,239,240,257,258,259,260,261,262,263,264,265,266,267,268,269,270,271,256,272,273,274,275,276,277,278,279,280,281,282,283,284,285,286,287,288,257,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,258,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,259,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,260,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,261,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,262,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,263,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,264,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,265,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,266,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,267,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,268,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,269,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,270,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,271,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255,272,256,273,274,275,276,277,278,279,280,281,282,283,284,285,286,287,288,273,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,274,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,275,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,276,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,277,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,278,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,279,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,280,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,281,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,282,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,283,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,284,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,285,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,286,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,287,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255,288,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,271,272
};

const char *NAME_ND[] = {"ND1_S", "ND1_R", "ND2_S", "ND2_R", "ND3_S", "ND3_R"};

const double FRAME_INTERVAL[] = {ASYNC_FRAME_INTERVAL, OFFNET_FRAME_INTERVAL, INNET_FRAME_INTERVAL};
const int NUM_ND[] = {1, 1, 1};
const int NUM_DT[] = {17, 17, 17};


const int SCAN_ROUND[] = {288, 288, 288};

typedef class opnet_pri_packet : public pri_packet
{
public:
  void *get_packet() const;
  opnet_pri_packet(Packet *p, int prio);
  ~opnet_pri_packet();

private:
  Packet *opnet_packet;

} opnet_pri_packet_t;

typedef class opnet_pri_queue : public transfer_queue
{
  private:
    std::vector<unsigned long> buf_size_by_prio;
  public:
    opnet_pri_queue();
    unsigned long calc_size(dtdma_ns::prio_t prio)const;
    unsigned long calc_size()const;
    void push(const pri_packet_t &p);
    void pop();
  
}opnet_pri_queue_t;

typedef class dtdma
{
private:
  Objid obj;
  node_t *self;
  antenna_t ant;
  int id;
  bool scan_mode[18];
  int cur_scan_sec;
  int status;
  unsigned short scan_count;
  unsigned long long dt_count;
  angle_t scan_seq[2][288];
  angle_t beam_seq[48];            //Store the sector info of a neighbor
  unsigned long long seq_num[48]; // Store the latest known sequence number of broadcast info
  unsigned long long my_seq_num;  // My broadcasting seq num
  balloc::beacon_t beacon_table[34];
  opnet_pri_queue txQ[48]; //Support maximum 20 transfer queue
  link_t forward_table[48];
  std::deque<Packet *> broadcast_stack;
  std::deque<Packet *> link_info_stack;
  position_manager_t* pos_mngr;
  friend class position_manager;

public:
  dtdma();
  ~dtdma();
  void update_forward_table(Packet *p);
  void update_beacon_table(Packet *p);
  void recv_proc(Packet *p);
  void proc_broadcast(Packet *p);
  void proc_unicast(Packet *p);
  void send_queue_info();
  void send_proc(int d, int dc);
  Packet *encap_mac(Packet *p, int dst, int prio, int type);
  Packet *encap_broadcast(Packet *p);
  friend class idle;

} dtdma_t;